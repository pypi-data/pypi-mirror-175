[tox]
basepython = python3
minversion = 2.0
# add docs to the list of environments once we actually have docs to generate
envlist = py3,pep8,molecule,linters
skipsdist = True

[testenv]
usedevelop = True
install_command = pip install {opts} {packages}
passenv = *
sitepackages = True
deps =
   -r {toxinidir}/requirements.txt
   -r {toxinidir}/ansible-requirements.txt
   -r {toxinidir}/test-requirements.txt
commands =
    ansible-galaxy install -fr {toxinidir}/ansible-collections-requirements.yml
    stestr run {posargs}
whitelist_externals =
  tox

[testenv:molecule]
install_command = pip install {opts} {packages}
setenv =
  ANSIBLE_FILTER_PLUGINS=~/.ansible/plugins/filter:/usr/share/ansible/plugins/filter:{toxinidir}/tripleo_ipa/ansible_plugins/filter
  ANSIBLE_LIBRARY=~/.ansible/plugins/modules:/usr/share/ansible/plugins/modules:{toxinidir}/tripleo_ipa/ansible_plugins/modules
  ANSIBLE_ROLES_PATH=~/.ansible/roles:/usr/share/ansible/roles:/etc/ansible/roles:{toxinidir}/tripleo_ipa/roles
deps =
   -r {toxinidir}/requirements.txt
   -r {toxinidir}/molecule-requirements.txt
changedir = {toxinidir}/tripleo_ipa
commands =
  ansible-galaxy install -fr {toxinidir}/ansible-collections-requirements.yml
  molecule test --all

[testenv:ansible-lint]
deps = {[testenv:linters]deps}
commands =
  ansible-galaxy install -fr {toxinidir}/ansible-collections-requirements.yml
  ansible-lint -c .ansible-lint {toxinidir}/tripleo_ipa

[testenv:yamllint]
deps = {[testenv:linters]deps}
commands =
  yamllint -c {toxinidir}/tripleo_ipa/.yamllint {toxinidir}/tripleo_ipa

[testenv:linters]
setenv =
  ANSIBLE_FILTER_PLUGINS=~/.ansible/plugins/filter:/usr/share/ansible/plugins/filter:{toxinidir}/tripleo_ipa/ansible_plugins/filter
  ANSIBLE_LIBRARY=~/.ansible/plugins/modules:/usr/share/ansible/plugins/modules:{toxinidir}/tripleo_ipa/ansible_plugins/modules
  ANSIBLE_ROLES_PATH=~/.ansible/roles:/usr/share/ansible/roles:/etc/ansible/roles:{toxinidir}/tripleo_ipa/roles
deps =
   -r {toxinidir}/ansible-requirements.txt
   -r {toxinidir}/test-requirements.txt
commands =
  {[testenv:ansible-lint]commands}
  {[testenv:yamllint]commands}

[testenv:pep8]
envdir = {toxworkdir}/linters
commands =
    python -m pre_commit run flake8 -a
